<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ø MN90Mobile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #001a33 0%, #003366 50%, #004d99 100%);
            min-height: 100vh;
            color: #fff;
            overflow: hidden;
        }

        .main-wrapper {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.95), rgba(0, 153, 255, 0.95));
            padding: 8px 10px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .header h1 { font-size: 18px; margin-bottom: 3px; }

        .tabs {
            display: flex;
            gap: 6px;
            background: rgba(0, 51, 102, 0.8);
            padding: 6px;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 6px 12px;
            cursor: pointer;
            border: 2px solid transparent;
            font-weight: 600;
            border-radius: 8px;
            background: rgba(0, 153, 255, 0.2);
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: rgba(0, 153, 255, 0.5);
            border-color: #00ffff;
        }

        .content-wrapper {
            display: flex;
            height: calc(100vh - 120px);
            gap: 0;
            padding: 0;
            flex: 1;
            position: relative;
            flex-direction: column;
        }

        .left-panel {
            flex: 0 0 auto;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 8px;
            min-width: 100%;
            min-height: 0;
        }

        .splitter {
            width: 100%;
            height: 6px;
            background: linear-gradient(180deg, rgba(0,255,255,0.3), rgba(0,255,255,0.6), rgba(0,255,255,0.3));
            cursor: row-resize;
            border-top: 1px solid rgba(0,255,255,0.4);
            border-bottom: 1px solid rgba(0,255,255,0.4);
            transition: background 0.2s;
            flex-shrink: 0;
            user-select: none;
        }

        .splitter:hover {
            background: linear-gradient(180deg, rgba(0,255,255,0.5), rgba(0,255,255,0.9), rgba(0,255,255,0.5));
        }

        .right-panel {
            flex: 0 0 25vh;
            display: flex;
            flex-direction: column;
            padding: 8px;
            min-height: 150px;
            max-height: 70vh;
        }

        /* RESPONSIVE MOBILE */
        @media (min-width: 1024px) {
            .content-wrapper {
                flex-direction: row;
                height: calc(100vh - 120px);
                padding: 8px;
            }

            .left-panel {
                flex: 0 0 35%;
                padding-right: 8px;
                padding: 0 8px 8px 8px;
                min-width: 250px;
            }

            .splitter {
                width: 6px;
                height: auto;
                background: linear-gradient(90deg, rgba(0,255,255,0.3), rgba(0,255,255,0.6), rgba(0,255,255,0.3));
                cursor: col-resize;
                border-left: 1px solid rgba(0,255,255,0.4);
                border-right: 1px solid rgba(0,255,255,0.4);
                border-top: none;
                border-bottom: none;
            }

            .right-panel {
                flex: 1;
                padding-left: 8px;
                padding: 0 8px 8px 8px;
                min-height: auto;
                max-height: none;
                min-width: 300px;
                flex: 0 0 auto;
            }
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
        }

        .section-title {
            font-size: 12px;
            color: #00ffff;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 1023px) {
            .header h1 {
                font-size: 16px;
            }

            .tab-btn {
                padding: 5px 10px;
                font-size: 10px;
            }

            .section {
                padding: 8px;
                margin-bottom: 4px;
            }

            .result-box {
                padding: 6px;
                margin: 3px 0;
                font-size: 10px;
            }

            .result-value {
                font-size: 14px;
                margin-top: 2px;
            }

            .slider-label {
                font-size: 9px;
                margin-bottom: 2px;
            }

            .graph-container {
                border-radius: 8px;
                padding: 6px;
            }

            .graph-explanation {
                font-size: 9px;
                margin-top: 4px;
                padding: 6px;
            }

            .legend {
                gap: 6px;
                font-size: 8px;
                margin-top: 4px;
            }

            .info-box {
                padding: 6px;
                font-size: 9px;
                margin-top: 4px;
            }
        }

        .slider-group {
            margin-bottom: 10px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .slider-label span {
            color: #00ffff;
            font-weight: bold;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #00ffff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #00ffff;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 8px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .result-box {
            background: rgba(0, 200, 255, 0.15);
            padding: 8px;
            border-radius: 8px;
            border-left: 4px solid #00ffff;
            margin: 4px 0;
            font-size: 11px;
        }

        .result-label {
            color: #aaa;
            font-size: 9px;
        }

        .result-value {
            color: #00ffff;
            font-size: 16px;
            font-weight: bold;
            margin-top: 3px;
        }

        .graph-container {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ffff;
            border-radius: 12px;
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 150px;
        }

        canvas {
            flex: 1;
            min-height: 100px;
        }

        @media (max-width: 1023px) {
            .graph-container {
                border-radius: 8px;
                padding: 6px;
                min-height: 120px;
            }
        }

        .graph-explanation {
            font-size: 10px;
            color: #00ffff;
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 6px;
            line-height: 1.5;
        }

        .legend {
            display: flex;
            gap: 12px;
            font-size: 9px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            overflow-y: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(0, 51, 102, 0.95), rgba(0, 102, 204, 0.95));
            margin: 20px;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #00ffff;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
        }

        .close {
            color: #00ffff;
            float: right;
            font-size: 28px;
            cursor: pointer;
            font-weight: bold;
        }

        .close:hover {
            color: #fff;
        }

        .modal h2 {
            color: #00ffff;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(800px, 1fr));
            gap: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8px;
        }

        table caption {
            color: #00ffff;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: left;
            font-size: 10px;
        }

        table th, table td {
            border: 1px solid rgba(0, 255, 255, 0.3);
            padding: 2px 3px;
            text-align: center;
        }

        table th {
            background: rgba(0, 153, 255, 0.3);
            color: #00ffff;
            font-weight: bold;
        }

        table tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.2);
        }

        button {
            padding: 8px 12px;
            background: rgba(0, 200, 255, 0.3);
            border: 2px solid #00ccff;
            border-radius: 6px;
            color: #00ffff;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            margin: 4px 0;
            width: 100%;
        }

        button:hover {
            background: rgba(0, 200, 255, 0.5);
        }

        .info-box {
            background: rgba(255, 200, 0, 0.1);
            border-left: 4px solid #FFC107;
            padding: 8px;
            margin-top: 8px;
            font-size: 10px;
            border-radius: 4px;
            line-height: 1.4;
        }

        /* ANIMATIONS FOND MARIN */
        @keyframes bubble-rise {
            0% {
                bottom: -10px;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                bottom: 100vh;
                opacity: 0;
            }
        }

        @keyframes fish-swim {
            0% {
                left: -50px;
                transform: scaleX(-1);
            }
            50% {
                left: 50%;
            }
            100% {
                left: 100vw;
                transform: scaleX(-1);
            }
        }

        @keyframes fish-swim-reverse {
            0% {
                right: -50px;
                transform: scaleX(1);
            }
            50% {
                right: 50%;
            }
            100% {
                right: 100vw;
                transform: scaleX(1);
            }
        }

        @keyframes sway {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(10px);
            }
        }

        .underwater-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
            overflow: hidden;
        }

        .bubble {
            position: absolute;
            background: radial-gradient(circle at 30% 30%, rgba(100, 200, 255, 0.8), rgba(0, 150, 255, 0.3));
            border-radius: 50%;
            opacity: 0.6;
            animation: bubble-rise linear infinite;
        }

        .bubble.small {
            width: 5px;
            height: 5px;
            animation-duration: 4s;
        }

        .bubble.medium {
            width: 10px;
            height: 10px;
            animation-duration: 5s;
        }

        .bubble.large {
            width: 15px;
            height: 15px;
            animation-duration: 6s;
        }

        .fish-emoji {
            position: absolute;
            font-size: 30px;
            opacity: 0.7;
            animation: fish-swim linear infinite;
        }

        .fish-emoji.fish1 {
            top: 15%;
            animation-duration: 15s;
            animation-delay: 0s;
        }

        .fish-emoji.fish2 {
            top: 30%;
            animation: fish-swim-reverse linear infinite;
            animation-duration: 18s;
            animation-delay: 2s;
        }

        .fish-emoji.fish3 {
            top: 50%;
            animation-duration: 20s;
            animation-delay: 5s;
        }

        .fish-emoji.fish4 {
            top: 70%;
            animation: fish-swim-reverse linear infinite;
            animation-duration: 16s;
            animation-delay: 3s;
        }

        .seaweed {
            position: absolute;
            font-size: 40px;
            opacity: 0.5;
            animation: sway 3s ease-in-out infinite;
        }

        .seaweed.weed1 {
            left: 5%;
            bottom: 0;
            animation-delay: 0s;
        }

        .seaweed.weed2 {
            right: 10%;
            bottom: 0;
            animation-delay: 1s;
        }

        .seaweed.weed3 {
            left: 25%;
            bottom: 0;
            animation-delay: 2s;
        }

        .main-wrapper {
            position: relative;
            z-index: 2;
        }
    </style>
</head>
<body>
    <!-- Fond marin anim√© -->
    <div class="underwater-background" id="underwater">
        <!-- Les bulles seront g√©n√©r√©es par JS -->
    </div>

    <div class="main-wrapper">
        <div class="header">
            <h1>ü§ø MN90Mobile - Planificateur de Plong√©e</h1>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(0)">üìä Planificateur</button>
            <button class="tab-btn" onclick="switchTab(1)">ü´Å Autonomie Optimale</button>
            <button class="tab-btn" onclick="switchTab(2)">üìã Tables MN90</button>
        </div>

        <div class="content-wrapper">
            <!-- LEFT PANEL -->
            <div class="left-panel">
                <!-- TAB 0: PLANIFICATEUR -->
                <div id="tab0-left" style="display: flex; flex-direction: column; gap: 6px; width: 100%;">
                    <div class="section">
                        <div class="section-title">‚≠ê Plong√©e 1</div>
                        
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Profondeur</span>
                                <span id="depth1-val">20 m</span>
                            </div>
                            <input type="range" id="depth1" min="6" max="65" value="20" oninput="updateSlider(this); calculate()">
                        </div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Temps au fond</span>
                                <span id="time1-val">20 min</span>
                            </div>
                            <input type="range" id="time1" min="1" max="400" value="20" oninput="updateSlider(this); calculate()">
                        </div>

                        <div class="result-box">
                            <div class="result-label" style="color: #FFA500; font-weight: bold;">üìä Palier 6m</div>
                            <div class="result-value" id="palier6m1">-- min</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label" style="color: #22FF00; font-weight: bold;">üìä Palier 3m</div>
                            <div class="result-value" id="palier3m1">-- min</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Temps total (DTR)</div>
                            <div class="result-value" id="total1">-- min</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">GPS (Groupe de Plong√©e)</div>
                            <div class="result-value" id="gps1">--</div>
                        </div>

                        <div class="info-box">
                            <strong>‚ÑπÔ∏è Explication:</strong><br>
                            ‚Ä¢ <strong style="color: #FFA500;">Palier 6m</strong> = Obligatoire selon MN90, d√©pend de la profondeur et dur√©e<br>
                            ‚Ä¢ <strong style="color: #22FF00;">Palier 3m</strong> = S√©curit√© suppl√©mentaire pour diminuer risque d'ADD
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">üîó Plong√©e Successive</div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="plongee2" onchange="togglePlongee2()">
                            <label>Ajouter 2√®me plong√©e</label>
                        </div>
                    </div>

                    <div id="plongee2-section" style="display: none; width: 100%;">
                        <div class="section">
                            <div class="section-title" style="color: #fff;">‚è±Ô∏è Intervalle en Surface</div>
                            <div class="slider-group">
                                <div class="slider-label">
                                    <span style="color: #fff;">Dur√©e intervalle</span>
                                    <span id="interval-val" style="color: #fff;">60 min</span>
                                </div>
                                <input type="range" id="interval" min="15" max="720" value="60" oninput="updateSlider(this); calculate()">
                            </div>
                        </div>

                        <div class="section">
                            <div class="section-title">‚≠ê Plong√©e 2</div>
                            <div class="slider-group">
                                <div class="slider-label">
                                    <span>Profondeur</span>
                                    <span id="depth2-val">15 m</span>
                                </div>
                                <input type="range" id="depth2" min="6" max="65" value="15" oninput="updateSlider(this); calculate()">
                            </div>

                            <div class="slider-group">
                                <div class="slider-label">
                                    <span>Temps au fond</span>
                                    <span id="time2-val">20 min</span>
                                </div>
                                <input type="range" id="time2" min="1" max="400" value="20" oninput="updateSlider(this); calculate()">
                            </div>

                            <div class="result-box">
                                <div class="result-label">Majoration</div>
                                <div class="result-value" id="majoration">-- min</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label" style="color: #FFA500; font-weight: bold;">üìä Palier 6m</div>
                                <div class="result-value" id="palier6m2">-- min</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label" style="color: #22FF00; font-weight: bold;">üìä Palier 3m</div>
                                <div class="result-value" id="palier3m2">-- min</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">Temps total (DTR)</div>
                                <div class="result-value" id="total2">-- min</div>
                            </div>
                            <div class="result-box">
                                <div class="result-label">GPS (Groupe de Plong√©e)</div>
                                <div class="result-value" id="gps2">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 1: AUTONOMIE -->
                <div id="tab1-left" style="display: none; flex-direction: column; gap: 6px; width: 100%;">
                    <div class="section">
                        <div class="section-title">ü´Å Param√®tres Autonomie</div>
                        
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Profondeur vis√©e</span>
                                <span id="prof-auto-val">20 m</span>
                            </div>
                            <input type="range" id="prof-auto" min="6" max="60" value="20" oninput="updateSlider(this); calculateOptimalDive()">
                        </div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Conso moyenne en surface</span>
                                <span id="conso-auto-val">20 L/min</span>
                            </div>
                            <input type="range" id="conso-auto" min="5" max="100" value="20" oninput="updateSlider(this); calculateOptimalDive()">
                        </div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Bouteille</span>
                                <span id="bouteille-auto-val">12 L</span>
                            </div>
                            <input type="range" id="bouteille-auto" min="10" max="20" value="12" oninput="updateSlider(this); calculateOptimalDive()">
                        </div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Pression initiale</span>
                                <span id="pression-auto-val">200 bar</span>
                            </div>
                            <input type="range" id="pression-auto" min="50" max="300" value="200" oninput="updateSlider(this); calculateOptimalDive()">
                        </div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span>R√©serve de s√©curit√©</span>
                                <span id="secu-auto-val">50 bar</span>
                            </div>
                            <input type="range" id="secu-auto" min="0" max="100" value="50" oninput="updateSlider(this); calculateOptimalDive()">
                        </div>

                        <div class="section-title" style="margin-top: 15px;">üìä R√©sultats Autonomie</div>
                        
                        <div class="result-box">
                            <div class="result-label">Pression utilisable</div>
                            <div class="result-value" id="pressure-usable">-- bar</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Air disponible</div>
                            <div class="result-value" id="air-available">-- L</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Conso r√©elle √† profondeur</div>
                            <div class="result-value" id="conso-depth">-- L/min</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Temps max au fond</div>
                            <div class="result-value" id="time-max-fond">-- min</div>
                        </div>
                        <div class="result-box" style="border-left-color: #FF99FF;">
                            <div class="result-label">‚è±Ô∏è AUTONOMIE OPTIMALE (avec paliers)</div>
                            <div class="result-value" id="autonomy-optimal" style="color: #FF99FF;">-- min</div>
                        </div>

                        <div class="info-box" id="autonomy-explanation">
                        </div>
                    </div>
                </div>

                <!-- TAB 2: TABLES BUTTON -->
                <div id="tab2-left" style="display: none;">
                    <button onclick="openTablesModal()" style="margin-top: 50%; padding: 15px; font-size: 14px; font-weight: bold;">üìä AFFICHER TABLES MN90 COMPL√àTES</button>
                    <div class="info-box" style="margin-top: 20px;">
                        Les tables MN90-FFESSM contiennent:<br>
                        ‚Ä¢ Tableau principal de d√©saturation<br>
                        ‚Ä¢ Tableau I: Azote r√©siduel<br>
                        ‚Ä¢ Tableau II: Majoration<br>
                        ‚Ä¢ Tableau III: R√©duction O2<br>
                        ‚Ä¢ Tableau IV: Remont√©e
                    </div>
                </div>
            </div>

            <!-- SPLITTER -->
            <div class="splitter" id="splitter"></div>

            <!-- RIGHT PANEL: GRAPH -->
            <div class="right-panel">
                <div class="graph-container">
                    <div style="color: #00ffff; font-weight: bold;" id="graph-title">Profil de Plong√©e</div>
                    <canvas id="profileCanvas"></canvas>
                    <div class="legend" id="graph-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #FF99FF;"></div>
                            <span>Plong√©e 1 (m)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #00CCFF;"></div>
                            <span>Plong√©e 2 (m)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffffff;"></div>
                            <span>Intervalle</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #FFA500;"></div>
                            <span>Palier 6m</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #22FF00;"></div>
                            <span>Palier 3m</span>
                        </div>
                    </div>
                    <div class="graph-explanation" id="graph-explanation"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL TABLES -->
    <div id="tablesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTablesModal()">&times;</span>
            <h2>üìä Tables MN90-FFESSM (Plong√©e √† l'Air) - COMPL√àTES</h2>
            <div class="tables-grid" id="tables-container"></div>
        </div>
    </div>

    <script>
        // ===== ANIMATIONS FOND MARIN =====
        function createUnderwater() {
            const underwater = document.getElementById('underwater');
            
            // Cr√©er les bulles
            for (let i = 0; i < 15; i++) {
                const bubble = document.createElement('div');
                const size = Math.random() > 0.7 ? 'large' : Math.random() > 0.5 ? 'medium' : 'small';
                bubble.className = `bubble ${size}`;
                bubble.style.left = Math.random() * 100 + '%';
                bubble.style.bottom = Math.random() * -50 + 'px';
                bubble.style.animationDelay = Math.random() * 5 + 's';
                underwater.appendChild(bubble);
            }

            // Cr√©er les poissons
            const fishes = ['üê†', 'üêü', 'ü¶à', 'üêô'];
            for (let i = 1; i <= 4; i++) {
                const fish = document.createElement('div');
                fish.className = `fish-emoji fish${i}`;
                fish.textContent = fishes[Math.floor(Math.random() * fishes.length)];
                fish.style.left = Math.random() * 100 + '%';
                underwater.appendChild(fish);
            }

            // Cr√©er les algues
            const weeds = ['üåø', 'ü™∑', 'üå±'];
            const weedCount = 3;
            for (let i = 1; i <= weedCount; i++) {
                const weed = document.createElement('div');
                weed.className = `seaweed weed${i}`;
                weed.textContent = weeds[Math.floor(Math.random() * weeds.length)];
                underwater.appendChild(weed);
            }
        }

        // Initialiser le fond marin
        createUnderwater();

        // ===== TABLES ET LOGIQUE PLONG√âE =====
        const officialTables = {
            6: [[6,1,1,'A'],[15,1,1,'B'],[30,1,1,'C'],[45,1,1,'D'],[75,1,1,'D'],[105,1,1,'E'],[135,1,1,'F'],[180,1,1,'G'],[240,1,1,'H'],[315,1,1,'I'],[360,1,1,'J']],
            8: [[15,1,1,'B'],[30,1,1,'C'],[45,1,1,'D'],[60,1,1,'E'],[90,1,1,'F'],[105,1,1,'G'],[135,1,1,'H'],[165,1,1,'I'],[195,1,1,'J'],[255,1,1,'K'],[300,1,1,'L'],[360,1,1,'M']],
            10: [[15,1,1,'B'],[30,1,1,'C'],[45,1,1,'D'],[60,1,1,'F'],[75,1,1,'G'],[105,1,1,'H'],[120,1,1,'I'],[135,1,1,'J'],[165,1,1,'K'],[180,1,1,'L'],[240,1,1,'M'],[255,1,1,'N'],[315,1,1,'O'],[330,1,1,'P'],[360,1,2,'P']],
            12: [[5,1,1,'A'],[10,1,1,'B'],[15,1,1,'B'],[20,1,1,'C'],[25,1,1,'C'],[30,1,1,'D'],[35,1,1,'D'],[40,1,1,'E'],[45,1,1,'E'],[50,1,1,'F'],[55,1,1,'F'],[60,1,1,'G'],[65,1,1,'G'],[70,1,1,'H'],[75,1,1,'H']],
            15: [[5,2,1,'B'],[10,2,1,'B'],[15,2,1,'C'],[20,2,1,'D'],[25,2,1,'E'],[30,2,1,'F'],[35,2,1,'G'],[40,2,4,'I'],[45,7,9,'I'],[50,12,14,'J'],[55,16,18,'K'],[60,20,22,'K'],[65,25,27,'L'],[70,29,31,'L'],[75,33,35,'M']],
            18: [[5,2,1,'B'],[10,2,1,'B'],[15,2,1,'D'],[20,2,1,'D'],[25,2,1,'E'],[30,2,1,'F'],[35,2,1,'G'],[40,2,1,'H'],[45,1,3,'I'],[50,4,6,'I'],[55,9,11,'J'],[60,13,15,'K'],[65,16,18,'K'],[70,20,22,'L'],[75,24,26,'L']],
            20: [[5,2,1,'B'],[10,2,1,'B'],[15,2,1,'D'],[20,2,1,'D'],[25,2,1,'E'],[30,2,1,'F'],[35,2,1,'G'],[40,2,1,'H'],[45,1,3,'I'],[50,4,6,'I'],[55,9,11,'J'],[60,13,15,'K'],[65,16,18,'K'],[70,20,22,'L'],[75,24,26,'L']],
            25: [[5,2,1,'B'],[10,2,1,'D'],[15,2,1,'E'],[20,1,4,'F'],[25,2,5,'G'],[30,6,9,'H'],[35,12,15,'I'],[40,19,22,'J'],[45,25,28,'K'],[50,32,35,'L']],
            30: [[5,2,1,'B'],[10,2,1,'D'],[15,1,4,'E'],[20,2,5,'F'],[25,4,7,'H'],[30,9,12,'I'],[35,17,20,'J'],[40,24,27,'K'],[45,1,31,35,'L'],[50,3,36,42,'M']],
            40: [[5,3,1,'B'],[10,3,1,'D'],[15,2,5,'E'],[20,5,8,'H'],[25,11,14,'I'],[30,1,20,24,'J'],[35,2,27,32,'K'],[40,5,34,42,'L']],
            50: [[5,1,5,'D'],[10,1,4,10,'F'],[15,3,10,18,'I'],[20,1,5,23,34,'K']],
            60: [[5,2,7,9,'D'],[10,2,7,14,'G']]
        };

        let chart1 = null;
        let currentTab = 0;
        let isDraggingSplitter = false;

        // Gestion du splitter redimensionnable (mobile ET desktop)
        document.getElementById('splitter').addEventListener('mousedown', (e) => {
            isDraggingSplitter = true;
            document.body.style.cursor = window.innerWidth >= 1024 ? 'col-resize' : 'row-resize';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDraggingSplitter) return;

            const contentWrapper = document.querySelector('.content-wrapper');
            const leftPanel = document.querySelector('.left-panel');
            const rightPanel = document.querySelector('.right-panel');
            const wrapperRect = contentWrapper.getBoundingClientRect();
            const isMobile = window.innerWidth < 1024;

            if (isMobile) {
                // Mode MOBILE: redimensionnement vertical
                const newHeight = e.clientY - wrapperRect.top;
                const percentage = (newHeight / wrapperRect.height) * 100;

                if (percentage > 20 && percentage < 80) {
                    leftPanel.style.flex = `0 0 ${percentage}%`;
                    rightPanel.style.flex = `0 0 ${100 - percentage}%`;
                }
            } else {
                // Mode DESKTOP: redimensionnement horizontal
                const newWidth = e.clientX - wrapperRect.left;
                const percentage = (newWidth / wrapperRect.width) * 100;

                if (percentage > 20 && percentage < 80) {
                    leftPanel.style.flex = `0 0 ${percentage}%`;
                }
            }
        });

        document.addEventListener('mouseup', () => {
            isDraggingSplitter = false;
            document.body.style.cursor = 'default';
        });

        // Redimensionner le chart quand la fen√™tre change de taille
        window.addEventListener('resize', () => {
            if (chart1) setTimeout(() => chart1.resize(), 100);
        });

        function switchTab(tabNum) {
            currentTab = tabNum;
            const isMobile = window.innerWidth < 1024;

            document.getElementById('tab0-left').style.display = tabNum === 0 ? (isMobile ? 'flex' : 'flex') : 'none';
            document.getElementById('tab1-left').style.display = tabNum === 1 ? (isMobile ? 'flex' : 'flex') : 'none';
            document.getElementById('tab2-left').style.display = tabNum === 2 ? 'block' : 'none';

            document.querySelectorAll('.tab-btn').forEach((el, i) => {
                el.classList.toggle('active', i === tabNum);
            });

            if (tabNum === 0) {
                document.getElementById('graph-title').textContent = 'Profil de Plong√©e';
                calculate();
            } else if (tabNum === 1) {
                document.getElementById('graph-title').textContent = 'Profil Optimal (Rose)';
                calculateOptimalDive();
            }

            if (chart1) setTimeout(() => chart1.resize(), 100);
        }

        function updateSlider(slider) {
            const valSpan = document.getElementById(slider.id + '-val');
            if (valSpan) {
                const unit = slider.id.includes('time') || slider.id.includes('interval') ? ' min' : 
                            slider.id.includes('pression') ? ' bar' :
                            slider.id.includes('conso') ? ' L/min' :
                            slider.id.includes('bouteille') ? ' L' : ' m';
                valSpan.textContent = slider.value + unit;
            }
        }

        function findClosestTable(depth) {
            const available = Object.keys(officialTables).map(Number);
            return available.reduce((p, c) => Math.abs(c - depth) < Math.abs(p - depth) ? c : p);
        }

        function getTableEntry(depth, time) {
            const tableDepth = findClosestTable(depth);
            let best = officialTables[tableDepth][0];
            for (let entry of officialTables[tableDepth]) {
                if (entry[0] <= time) best = entry;
            }
            return best;
        }

        function calculate() {
            const depth1 = parseInt(document.getElementById('depth1').value);
            const time1 = parseInt(document.getElementById('time1').value);
            const hasPlongee2 = document.getElementById('plongee2').checked;

            if (depth1 <= 0 || time1 <= 0) return;

            const entry1 = getTableEntry(depth1, time1);
            const palier3m1 = entry1[1];
            const palier6m1 = entry1[2];
            const gps1 = entry1[3];

            document.getElementById('palier6m1').textContent = palier6m1 + ' min';
            document.getElementById('palier3m1').textContent = palier3m1 + ' min';
            document.getElementById('gps1').textContent = gps1;

            const descente = depth1 / 15;
            const remontee6 = (depth1 - 6) / 6;
            const remontee3 = 3 / 6;
            const total = time1 + descente + remontee6 + palier6m1 + remontee3 + palier3m1 + 0.5;

            document.getElementById('total1').textContent = Math.ceil(total) + ' min';

            if (hasPlongee2) {
                const depth2 = parseInt(document.getElementById('depth2').value);
                const time2 = parseInt(document.getElementById('time2').value);
                const interval = parseInt(document.getElementById('interval').value);

                const entry2 = getTableEntry(depth2, time2);
                const palier3m2 = entry2[1];
                const palier6m2 = entry2[2];
                const gps2 = entry2[3];

                // Majoration - simplifi√©e pour d√©mo
                const majoration = Math.max(0, 20 - Math.floor(interval / 10));

                document.getElementById('majoration').textContent = majoration + ' min';
                document.getElementById('palier6m2').textContent = palier6m2 + ' min';
                document.getElementById('palier3m2').textContent = palier3m2 + ' min';
                document.getElementById('gps2').textContent = gps2;

                const descente2 = depth2 / 15;
                const remontee6_2 = (depth2 - 6) / 6;
                const remontee3_2 = 3 / 6;
                const total2 = time2 + descente2 + remontee6_2 + palier6m2 + remontee3_2 + palier3m2 + 0.5;

                document.getElementById('total2').textContent = Math.ceil(total2) + ' min';

                updateChartDuoPlongees(depth1, time1, palier6m1, palier3m1, descente, remontee6, remontee3,
                                     depth2, time2, palier6m2, palier3m2, descente2, remontee6_2, remontee3_2, interval);
            } else {
                updateChartPlongee1(depth1, time1, palier6m1, palier3m1, descente, remontee6, remontee3);
            }
        }

        function updateChartPlongee1(depth1, time1, palier6m1, palier3m1, descente, remontee6, remontee3) {
            const data = [
                { x: 0, y: 0, phase: 'surface', label: 'SURFACE - D√©but' },
                { x: descente, y: -depth1, phase: 'descente', label: `DESCENTE - Arriv√©e √† ${depth1}m` },
                { x: descente + time1, y: -depth1, phase: 'fond', label: `FOND - Fin du temps d'immersion` },
                { x: descente + time1 + remontee6, y: -6, phase: 'palier6m', label: `PALIER 6M OBLIGATOIRE - Remont√©e` },
                { x: descente + time1 + remontee6 + palier6m1, y: -6, phase: 'palier6m', label: `FIN PALIER 6M` },
                { x: descente + time1 + remontee6 + palier6m1 + remontee3, y: -3, phase: 'palier3m', label: `PALIER 3M S√âCURIT√â` },
                { x: descente + time1 + remontee6 + palier6m1 + remontee3 + palier3m1, y: -3, phase: 'palier3m', label: `FIN PALIER 3M` },
                { x: descente + time1 + remontee6 + palier6m1 + remontee3 + palier3m1 + 0.5, y: 0, phase: 'surface', label: 'SURFACE - Fin' }
            ];

            const config = {
                type: 'line',
                data: {
                    datasets: [{
                        label: `${time1}min @ ${depth1}m`,
                        data: data,
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0,
                        pointRadius: 6,
                        pointBorderWidth: 2,
                        segment: {
                            borderColor: (ctx) => {
                                const point = data[ctx.p0DataIndex];
                                if (!point) return '#FF99FF';
                                if (point.phase === 'palier6m') return '#FFA500';
                                if (point.phase === 'palier3m') return '#22FF00';
                                return '#FF99FF';
                            }
                        },
                        borderColor: '#FF99FF',
                        pointBackgroundColor: '#FF99FF',
                        pointBorderColor: '#fff',
                        backgroundColor: 'rgba(255, 153, 255, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff', font: { size: 10 } } },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#00ffff',
                            bodyColor: '#fff',
                            borderColor: '#00ffff',
                            borderWidth: 2,
                            padding: 12,
                            titleFont: { size: 12, weight: 'bold' },
                            bodyFont: { size: 11 },
                            callbacks: {
                                title: function(context) {
                                    return data[context[0].dataIndex].label;
                                },
                                label: function(context) {
                                    const pt = data[context[0].dataIndex];
                                    return `Temps: ${pt.x.toFixed(1)}min | Profondeur: ${pt.y}m`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Profondeur (m)', color: '#fff' },
                            min: -depth1 - 2,
                            max: 2,
                            ticks: { color: '#aaa', font: { size: 9 } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Temps (min)', color: '#fff' },
                            ticks: { color: '#aaa', font: { size: 9 } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            };

            if (chart1) chart1.destroy();
            const ctx = document.getElementById('profileCanvas');
            chart1 = new Chart(ctx, config);

            const explication = `
                <strong>üìñ Profil de Plong√©e:</strong><br>
                Je plonge jusqu'√† <strong>${depth1}m</strong> en <strong>${descente.toFixed(1)} min</strong>,
                je tiens <strong>${time1} min</strong> au fond, je remonte au palier √† <strong>6m</strong> en <strong>${remontee6.toFixed(1)} min</strong>.
                Je fais un palier de <strong>${palier6m1} min √† 6m</strong> (obligatoire MN90),
                puis un palier de <strong>${palier3m1} min √† 3m</strong> (s√©curit√©).
                Temps total: <strong>${(descente + time1 + remontee6 + palier6m1 + remontee3 + palier3m1 + 0.5).toFixed(1)} min</strong> üéØ
            `;
            document.getElementById('graph-explanation').innerHTML = explication;
        }

        function updateChartDuoPlongees(depth1, time1, palier6m1, palier3m1, descente, remontee6, remontee3,
                                       depth2, time2, palier6m2, palier3m2, descente2, remontee6_2, remontee3_2, interval) {
            // Plong√©e 1
            const totalP1 = descente + time1 + remontee6 + palier6m1 + remontee3 + palier3m1;
            const startP2 = totalP1 + interval;

            const data1 = [
                { x: 0, y: 0, phase: 'surface' },
                { x: descente, y: -depth1, phase: 'descente' },
                { x: descente + time1, y: -depth1, phase: 'fond' },
                { x: descente + time1 + remontee6, y: -6, phase: 'palier6m' },
                { x: descente + time1 + remontee6 + palier6m1, y: -6, phase: 'palier6m' },
                { x: descente + time1 + remontee6 + palier6m1 + remontee3, y: -3, phase: 'palier3m' },
                { x: totalP1, y: -3, phase: 'palier3m' },
                { x: totalP1, y: 0, phase: 'surface' },
                { x: startP2, y: 0, phase: 'surface' }
            ];

            const data2 = [
                { x: startP2, y: 0, phase: 'surface' },
                { x: startP2 + descente2, y: -depth2, phase: 'descente' },
                { x: startP2 + descente2 + time2, y: -depth2, phase: 'fond' },
                { x: startP2 + descente2 + time2 + remontee6_2, y: -6, phase: 'palier6m' },
                { x: startP2 + descente2 + time2 + remontee6_2 + palier6m2, y: -6, phase: 'palier6m' },
                { x: startP2 + descente2 + time2 + remontee6_2 + palier6m2 + remontee3_2, y: -3, phase: 'palier3m' },
                { x: startP2 + descente2 + time2 + remontee6_2 + palier6m2 + remontee3_2 + palier3m2, y: -3, phase: 'palier3m' },
                { x: startP2 + descente2 + time2 + remontee6_2 + palier6m2 + remontee3_2 + palier3m2 + 0.5, y: 0, phase: 'surface' }
            ];

            const config = {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: `Plong√©e 1: ${time1}min @ ${depth1}m`,
                            data: data1,
                            borderWidth: 2.5,
                            fill: true,
                            tension: 0,
                            pointRadius: 4,
                            segment: {
                                borderColor: (ctx) => {
                                    const point = data1[ctx.p0DataIndex];
                                    if (!point) return '#FF99FF';
                                    if (point.phase === 'palier6m') return '#FFA500';
                                    if (point.phase === 'palier3m') return '#22FF00';
                                    return '#FF99FF';
                                }
                            },
                            borderColor: '#FF99FF',
                            pointBackgroundColor: '#FF99FF',
                            pointBorderColor: '#fff',
                            backgroundColor: 'rgba(255, 153, 255, 0.1)'
                        },
                        {
                            label: `Intervalle surface: ${interval}min`,
                            data: [
                                { x: totalP1, y: 0 },
                                { x: startP2, y: 0 }
                            ],
                            borderWidth: 3,
                            borderColor: '#ffffff',
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            borderDash: [5, 5],
                            pointBackgroundColor: '#ffffff'
                        },
                        {
                            label: `Plong√©e 2: ${time2}min @ ${depth2}m`,
                            data: data2,
                            borderWidth: 2.5,
                            fill: true,
                            tension: 0,
                            pointRadius: 4,
                            segment: {
                                borderColor: (ctx) => {
                                    const point = data2[ctx.p0DataIndex];
                                    if (!point) return '#00CCFF';
                                    if (point.phase === 'palier6m') return '#FFA500';
                                    if (point.phase === 'palier3m') return '#22FF00';
                                    return '#00CCFF';
                                }
                            },
                            borderColor: '#00CCFF',
                            pointBackgroundColor: '#00CCFF',
                            pointBorderColor: '#fff',
                            backgroundColor: 'rgba(0, 204, 255, 0.1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff', font: { size: 10 } } },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#00ffff',
                            bodyColor: '#fff',
                            borderColor: '#00ffff',
                            borderWidth: 2,
                            padding: 12
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Profondeur (m)', color: '#fff' },
                            min: -Math.max(depth1, depth2) - 2,
                            max: 2,
                            ticks: { color: '#aaa', font: { size: 9 } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Temps (min)', color: '#fff' },
                            ticks: { color: '#aaa', font: { size: 9 } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            };

            if (chart1) chart1.destroy();
            const ctx = document.getElementById('profileCanvas');
            chart1 = new Chart(ctx, config);

            const explication = `
                <strong>üìñ Duo de Plong√©es:</strong><br>
                <strong style="color: #FF99FF;">üî∑ Plong√©e 1:</strong> Profondeur <strong>${depth1}m</strong> pendant <strong>${time1} min</strong><br>
                &nbsp;&nbsp;‚Ä¢ Palier <strong style="color: #FFA500;">6m: ${palier6m1} min</strong> &nbsp; Palier <strong style="color: #22FF00;">3m: ${palier3m1} min</strong><br>
                <strong style="color: #aaa;">‚è±Ô∏è Intervalle surface:</strong> <strong style="color: #fff;">${interval} min</strong><br>
                <strong style="color: #00CCFF;">üî∑ Plong√©e 2:</strong> Profondeur <strong>${depth2}m</strong> pendant <strong>${time2} min</strong><br>
                &nbsp;&nbsp;‚Ä¢ Palier <strong style="color: #FFA500;">6m: ${palier6m2} min</strong> &nbsp; Palier <strong style="color: #22FF00;">3m: ${palier3m2} min</strong><br>
                <strong>‚è±Ô∏è Dur√©e totale:</strong> ${(startP2 + descente2 + time2 + remontee6_2 + palier6m2 + remontee3_2 + palier3m2 + 0.5).toFixed(1)} min üéØ
            `;
            document.getElementById('graph-explanation').innerHTML = explication;
        }

        function togglePlongee2() {
            const section = document.getElementById('plongee2-section');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            calculate();
        }

        function calculateOptimalDive() {
            const prof = parseInt(document.getElementById('prof-auto').value);
            const conso = parseInt(document.getElementById('conso-auto').value);  // Conso R√âELLE √† profondeur
            const bouteille = parseInt(document.getElementById('bouteille-auto').value);
            const pression = parseInt(document.getElementById('pression-auto').value);
            const secu = parseInt(document.getElementById('secu-auto').value);

            // La consommation est d√©j√† √† profondeur, pas besoin de coefficient
            const pressureUsable = pression - secu;
            const airAvailable = bouteille * pressureUsable;

            document.getElementById('pressure-usable').textContent = pressureUsable + ' bar';
            document.getElementById('air-available').textContent = airAvailable.toFixed(1) + ' L';
            document.getElementById('conso-depth').textContent = conso + ' L/min';

            const tableDepth = findClosestTable(prof);
            let optimalTime = 0, palier6m = 0, palier3m = 0;

            // Boucle pour trouver le temps optimal
            for (let entry of officialTables[tableDepth]) {
                const timeFond = entry[0];
                const p6 = entry[2];
                const p3 = entry[1];
                const descente = prof / 15;
                const remontee6 = (prof - 6) / 6;
                const remontee3 = 3 / 6;
                
                // Consommation r√©elle √† profondeur au fond
                const consoRemontee = conso * 0.4;  // Estimation: moins profond = moins de conso
                const consoPaliers = conso * 0.3;   // √Ä 3-6m, encore moins
                
                const totalConso = (timeFond * conso) + ((descente + remontee6 + remontee3) * consoRemontee) + ((p6 + p3) * consoPaliers);

                if (totalConso <= airAvailable) {
                    optimalTime = timeFond;
                    palier6m = p6;
                    palier3m = p3;
                }
            }

            document.getElementById('time-max-fond').textContent = optimalTime + ' min';
            const totalTime = Math.ceil(optimalTime + (prof/15) + ((prof-6)/6) + palier6m + (3/6) + palier3m);
            document.getElementById('autonomy-optimal').textContent = totalTime + ' min';

            const descente = prof / 15;
            const remontee6 = (prof - 6) / 6;
            const remontee3 = 3 / 6;
            const explication = `
                <strong>üéØ Plong√©e Optimale:</strong><br>
                √Ä <strong>${prof}m</strong> avec une consommation r√©elle de <strong>${conso} L/min</strong>,
                vous pouvez faire <strong>${optimalTime} min au fond</strong>.
                Temps total estim√©: <strong>${totalTime} min</strong> (descente + fond + paliers + remont√©e).
                Vous arriverez avec votre r√©serve de <strong>${secu} bar</strong>. ‚úì S√©curis√©!
            `;
            document.getElementById('autonomy-explanation').innerHTML = explication;

            drawOptimalProfile(prof, optimalTime, palier6m, palier3m);
        }

        function drawOptimalProfile(depth, timeFond, palier6m, palier3m) {
            const timeDescent = depth / 15;
            const timeRem6 = (depth - 6) / 6;
            const timeRem3 = 3 / 6;
            const conso = parseInt(document.getElementById('conso-auto').value);
            const bouteille = parseInt(document.getElementById('bouteille-auto').value);
            const pression = parseInt(document.getElementById('pression-auto').value);
            const secu = parseInt(document.getElementById('secu-auto').value);

            const data = [
                { x: 0, y: 0, phase: 'surface' },
                { x: timeDescent, y: -depth, phase: 'fond' },
                { x: timeDescent + timeFond, y: -depth, phase: 'fond' },
                { x: timeDescent + timeFond + timeRem6, y: -6, phase: 'palier6m' },
                { x: timeDescent + timeFond + timeRem6 + palier6m, y: -6, phase: 'palier6m' },
                { x: timeDescent + timeFond + timeRem6 + palier6m + timeRem3, y: -3, phase: 'palier3m' },
                { x: timeDescent + timeFond + timeRem6 + palier6m + timeRem3 + palier3m, y: -3, phase: 'palier3m' },
                { x: timeDescent + timeFond + timeRem6 + palier6m + timeRem3 + palier3m + 0.5, y: 0, phase: 'surface' }
            ];

            const getPressureColor = (pressBar) => {
                const percentage = pressBar / pression;
                if (percentage >= 0.75) return '#00FF00';
                if (percentage >= 0.5) return '#FFFF00';
                if (percentage >= 0.25) return '#FF6600';
                if (pressBar > secu) return '#FF3333';
                return '#000000';
            };

            const pressureData = [];
            let currentPressure = pression;

            pressureData.push({ x: 0, y: currentPressure, yAxisID: 'y1', color: getPressureColor(currentPressure) });

            // Descente - consommation progressive
            for (let t = 0; t <= timeDescent; t += 0.1) {
                const profAtT = (t / timeDescent) * depth;
                const consoAtT = conso * (profAtT / depth);  // Proportionnel √† la profondeur atteinte
                currentPressure = pression - (consoAtT * t / bouteille);
                pressureData.push({ x: t, y: Math.max(0, currentPressure), yAxisID: 'y1', color: getPressureColor(Math.max(0, currentPressure)) });
            }
            currentPressure = pression - (conso * timeDescent / bouteille);

            // Fond - consommation constante
            for (let t = 0; t <= timeFond; t += 0.1) {
                currentPressure = pression - (conso * (timeDescent + t) / bouteille);
                pressureData.push({ x: timeDescent + t, y: Math.max(0, currentPressure), yAxisID: 'y1', color: getPressureColor(Math.max(0, currentPressure)) });
            }
            currentPressure = pression - (conso * timeFond / bouteille + conso * timeDescent / bouteille);

            // Remont√©e 6m - consommation r√©duite
            const consoRem6 = conso * 0.5;
            for (let t = 0; t <= timeRem6; t += 0.1) {
                currentPressure = pression - (conso * timeFond / bouteille + conso * timeDescent / bouteille + consoRem6 * t / bouteille);
                pressureData.push({ x: timeDescent + timeFond + t, y: Math.max(0, currentPressure), yAxisID: 'y1', color: getPressureColor(Math.max(0, currentPressure)) });
            }

            // Palier 6m
            const consoPalier6 = conso * 0.4;
            for (let t = 0; t <= palier6m; t += 0.1) {
                currentPressure = pression - (conso * timeFond / bouteille + conso * timeDescent / bouteille + consoRem6 * timeRem6 / bouteille + consoPalier6 * t / bouteille);
                pressureData.push({ x: timeDescent + timeFond + timeRem6 + t, y: Math.max(0, currentPressure), yAxisID: 'y1', color: getPressureColor(Math.max(0, currentPressure)) });
            }

            // Remont√©e 3m
            const consoRem3 = conso * 0.3;
            for (let t = 0; t <= timeRem3; t += 0.1) {
                currentPressure = pression - (conso * timeFond / bouteille + conso * timeDescent / bouteille + consoRem6 * timeRem6 / bouteille + consoPalier6 * palier6m / bouteille + consoRem3 * t / bouteille);
                pressureData.push({ x: timeDescent + timeFond + timeRem6 + palier6m + t, y: Math.max(0, currentPressure), yAxisID: 'y1', color: getPressureColor(Math.max(0, currentPressure)) });
            }

            // Palier 3m
            const consoPalier3 = conso * 0.25;
            for (let t = 0; t <= palier3m; t += 0.1) {
                currentPressure = pression - (conso * timeFond / bouteille + conso * timeDescent / bouteille + consoRem6 * timeRem6 / bouteille + consoPalier6 * palier6m / bouteille + consoRem3 * timeRem3 / bouteille + consoPalier3 * t / bouteille);
                pressureData.push({ x: timeDescent + timeFond + timeRem6 + palier6m + timeRem3 + t, y: Math.max(0, currentPressure), yAxisID: 'y1', color: getPressureColor(Math.max(0, currentPressure)) });
            }

            const finalPressure = Math.max(0, pression - (conso * timeFond / bouteille + conso * timeDescent / bouteille + consoRem6 * timeRem6 / bouteille + consoPalier6 * palier6m / bouteille + consoRem3 * timeRem3 / bouteille + consoPalier3 * palier3m / bouteille));
            pressureData.push({ x: timeDescent + timeFond + timeRem6 + palier6m + timeRem3 + palier3m + 0.5, y: finalPressure, yAxisID: 'y1', color: getPressureColor(finalPressure) });

            const isSafe = finalPressure >= secu;
            const statusColor = isSafe ? '#22FF00' : '#FF3333';
            const statusText = isSafe ? `‚úÖ S√âCURIS√â! Vous remonterez avec ${Math.round(finalPressure)} bar (r√©serve: ${secu} bar)` : `‚ö†Ô∏è DANGER! Vous serez √† ${Math.round(finalPressure)} bar (r√©serve: ${secu} bar)`;

            document.getElementById('autonomy-explanation').innerHTML = `
                <strong>üéØ TEST DE FAISABILIT√â:</strong><br>
                <span style="color: ${statusColor};">${statusText}</span>
            `;

            const config = {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: `Profil: ${timeFond}min @ ${depth}m`,
                            data: data,
                            borderColor: '#FF99FF',
                            backgroundColor: 'rgba(255, 153, 255, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0,
                            pointRadius: 0,
                            yAxisID: 'y',
                            segment: {
                                borderColor: (ctx) => {
                                    const point = data[ctx.p0DataIndex];
                                    if (!point) return '#FF99FF';
                                    if (point.phase === 'palier6m') return '#FFA500';
                                    if (point.phase === 'palier3m') return '#22FF00';
                                    return '#FF99FF';
                                }
                            }
                        },
                        {
                            label: 'Pression (bar)',
                            data: pressureData,
                            borderColor: '#00CCFF',
                            backgroundColor: 'rgba(0, 204, 255, 0)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y1',
                            segment: {
                                borderColor: (ctx) => {
                                    return pressureData[ctx.p0DataIndex]?.color || '#00CCFF';
                                }
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff', font: { size: 10 } } },
                        tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.9)', bodyColor: '#fff', borderWidth: 2 }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Profondeur (m)', color: '#FF99FF', font: { weight: 'bold' } },
                            min: -depth - 2,
                            max: 2,
                            ticks: { color: '#FF99FF', font: { size: 9 } },
                            grid: { color: 'rgba(255, 153, 255, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Pression (bar)', color: '#00CCFF', font: { weight: 'bold' } },
                            min: 0,
                            max: pression + 20,
                            ticks: { color: '#00CCFF', font: { size: 9 } },
                            grid: { drawOnChartArea: false }
                        },
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Temps (min)', color: '#fff' },
                            ticks: { color: '#aaa', font: { size: 9 } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            };

            if (chart1) chart1.destroy();
            const ctx = document.getElementById('profileCanvas');
            chart1 = new Chart(ctx, config);
        }

        function openTablesModal() {
            let html = '';
            html += '<table><caption>üìä TABLEAU PRINCIPAL - D√©termination des Paliers (6-75m)</caption><thead><tr><th>Prof</th><th>Dur√©e</th><th>P3m</th><th>P6m</th><th>GPS</th></tr></thead><tbody>';
            for (const [depth, entries] of Object.entries(officialTables)) {
                for (const entry of entries) {
                    html += `<tr><td><b>${depth}m</b></td><td>${entry[0]}'</td><td>${entry[1]}</td><td>${entry[2]}</td><td><b>${entry[3]}</b></td></tr>`;
                }
            }
            html += '</tbody></table>';
            html += `<table><caption>üìã TABLEAU I - Azote R√©siduel</caption>
            <thead><tr><th>GPS</th><th>15m</th><th>30m</th><th>45m</th><th>1h</th><th>1h30</th><th>2h</th><th>2h30</th><th>3h</th><th>3h30</th><th>4h</th></tr></thead>
            <tbody>
            <tr><td>A</td><td>0.84</td><td>0.83</td><td>0.83</td><td>0.83</td><td>0.82</td><td>0.82</td><td>0.82</td><td>0.81</td><td>0.81</td><td>0.81</td></tr>
            </tbody></table>`;
            document.getElementById('tables-container').innerHTML = html;
            document.getElementById('tablesModal').style.display = 'block';
        }

        function closeTablesModal() {
            document.getElementById('tablesModal').style.display = 'none';
        }

        window.onclick = function(e) {
            const modal = document.getElementById('tablesModal');
            if (e.target === modal) modal.style.display = 'none';
        }

        updateSlider(document.getElementById('depth1'));
        updateSlider(document.getElementById('time1'));
        updateSlider(document.getElementById('prof-auto'));
        updateSlider(document.getElementById('conso-auto'));
        updateSlider(document.getElementById('bouteille-auto'));
        updateSlider(document.getElementById('pression-auto'));
        updateSlider(document.getElementById('secu-auto'));
        
        calculate();
        calculateOptimalDive();
    </script>
</body>
</html>